name: Deploy to Production (Hetzner Docker)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy Docker to Hetzner
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Next.js app
        run: npm run build
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build -t edufunds:latest .
          docker save edufunds:latest | gzip > edufunds-image.tar.gz
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to Hetzner
        run: |
          echo "üöÄ Deploying Docker image to Hetzner..."
          
          # Copy image to server
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            edufunds-image.tar.gz \
            ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }}:/tmp/
          
          # Load and deploy on server
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << 'EOF'
            echo "üì¶ Loading Docker image..."
            docker load < /tmp/edufunds-image.tar.gz
            
            echo "üõë Stopping old container..."
            docker stop edufunds 2>/dev/null || true
            docker rm edufunds 2>/dev/null || true
            
            echo "üöÄ Starting new container..."
            docker run -d --name edufunds \
              --network hetzner-stack_web \
              -e NODE_ENV=production \
              -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              -l 'traefik.enable=true' \
              -l 'traefik.docker.network=hetzner-stack_web' \
              -l 'traefik.http.routers.edufunds.rule=Host(`edufunds.org`) || Host(`www.edufunds.org`)' \
              -l 'traefik.http.routers.edufunds.entrypoints=websecure' \
              -l 'traefik.http.routers.edufunds.tls=true' \
              -l 'traefik.http.routers.edufunds.tls.certresolver=letsencrypt' \
              -l 'traefik.http.routers.edufunds.service=edufunds-service' \
              -l 'traefik.http.services.edufunds-service.loadbalancer.server.port=3000' \
              --restart unless-stopped \
              edufunds:latest
            
            echo "‚è≥ Waiting for container to be healthy..."
            sleep 10
            
            echo "üîç Checking container status..."
            docker ps | grep edufunds
            docker logs edufunds --tail 5
            
            echo "üßπ Cleaning up..."
            rm /tmp/edufunds-image.tar.gz
            
            echo "‚úÖ Deployment completed!"
          EOF
      
      - name: Health Check
        run: |
          echo "üè• Running health check..."
          sleep 5
          curl -sI https://edufunds.org | head -3 || echo "‚ö†Ô∏è Health check warning"
